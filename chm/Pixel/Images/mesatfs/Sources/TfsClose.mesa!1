-- File TfsClose.mesa--Last edited by:	GWilliams		December 14, 1981  2:31 PM--Changed type returned by TfsCloseDiskl2963(1792)\78i40IDIRECTORY	InlineDefs: FROM "inlinedefs" USING [COPY],	SystemDefs: FROM "systemdefs" USING [FreeHeapNode],	TridentDefs: FROM "tridentdefs" USING [tfsdskPtr, ddMgrPtr, TfsCloseDD, TfsDestroyDDMgr, TfsLockDD, TfsUnlockDD, TfsFlushDD, TfsReadDDPage, lTFSKDHeader];TfsClose: PROGRAM IMPORTS TridentDefs, SystemDefs, InlineDefs EXPORTS TridentDefs =BEGIN OPEN TridentDefs, SystemDefs, InlineDefs;(448)TfsCloseDisk: PUBLIC PROCEDURE [tfsDsk: tfsdskPtr, dontFree: BOOLEAN] RETURNS [result: tfsdskPtr]=	BEGIN		IF tfsDsk.tfskd.initmode # 0 THEN		BEGIN			TfsWriteDiskDescriptor[tfsDsk];									-- Write constant part of DD			TfsCloseDD[tfsDsk.tfskd.ddMgr, tfsDsk];							-- Close dd manager			IF ~dontFree THEN TfsDestroyDDMgr[tfsDsk.tfskd.ddMgr];	-- Erase it		END;		FreeHeapNode[tfsDsk];													-- Free the disk object		RETURN[NIL];															--for [disk] _ TfsCloseDisk[disk] to zero pointer for user	END;															-- of TfsCloseDisk\1b12B447i58ITfsWriteDiskDescriptor: PROCEDURE [tfsDsk: tfsdskPtr] =	BEGIN		ddMgr: ddMgrPtr;		bufferPtr: POINTER;		IF tfsDsk.tfskd.initmode # 0 THEN		BEGIN			ddMgr _ tfsDsk.tfskd.ddMgr;			TfsLockDD [ddMgr, tfsDsk];							-- Single use of DD manager			bufferPtr _ TfsReadDDPage[ddMgr, tfsDsk, 1];			COPY[tfsDsk, lTFSKDHeader, bufferPtr];						TfsUnlockDD[ddMgr, tfsDsk, FALSE];		-- Flush is coming up			TfsFlushDD[ddMgr, tfsDsk];							-- Write disk descriptor		END;	END;															-- of TfsWriteDiskDescriptorEND.																-- of TfsClose\2b22B--Last edited by:	GWilliams		July 23, 1981  11:02 AM
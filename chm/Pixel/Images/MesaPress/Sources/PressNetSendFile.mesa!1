-- File:  PressNetSendFile.mesa: Sends a Press.bits file to a printing server.e1(1792)\i-- Last Edited:  February 8, 1982  11:38 AM   By:  GWilliams--Can now address Platemaker. e1\iDIRECTORYe1IODefs USING[CR, ReadChar, ReadLine, ReadOctal, WriteChar, WriteLine, WriteString],l4269d3634e1k72(635)PressDefs USING [PressPassword],l4269d3634e1k72PressNetDefs USING [PageAttributes,--PressNetErr,Printer, PrinterAttributes,CloseConnection,GetPrinterAttributes,PrinterReady,SendPageAttributes,SetRetries,SendLine],l4269d3634e1k72\36i15I112i2ISegmentDefs USING[DataSegmentHandle, DefaultBase, DeleteDataSegment, NewDataSegment, Read, SegmentAddress],l4269d3634e1k72StreamDefs USING[NewWordStream, DiskHandle, ReadBlock, SetPosition, StreamPosition],l4269d3634e1k72StringDefs USING [UpperCase];l4269d3634e1k72e1(1792)\bPressNetSendFile: PROGRAMe1\b16BIMPORTS IODefs, PressNetDefs, SegmentDefs, StreamDefs, StringDefsl4904d3634e1k72(635)=l3633e1(1792)l3633d2998e1BEGIN OPEN IODefs, PressDefs, PressNetDefs, SegmentDefs, StreamDefs, StringDefs;l3633d2998e1	IllegalPressFile: ERROR = CODE;NoImageInFile: ERROR = CODE;FileTooShort: ERROR = CODE;--Pack Variables--ProcsSendImage: PROC[]=--Raises no signals or errorsBEGIN	attr: PageAttributes;	bandWidth: CARDINAL = 16;	bitPage: LONG CARDINAL;	ch: CHARACTER;	pa: PrinterAttributes;	bufferWordLen: CARDINAL = 1024;	bufferByteLen: CARDINAL = 2*bufferWordLen;	h: DiskHandle;	bufferSeg: DataSegmentHandle;	wordsRead: CARDINAL;	filename: STRING _ [200];	inCoreAddress: POINTER TO ARRAY [0..bufferWordLen) OF CARDINAL;	streamPosition: StreamPosition;	scratch: CARDINAL;	firstBand, lastBand, bitMargin, bitWordCt, frstScan, lstScan: CARDINAL;	scanNum: CARDINAL;	totalBands: LONG CARDINAL;	bandNum: LONG CARDINAL;	roundedBytesPerBand: LONG CARDINAL;	device: CARDINAL _ 0;	UNTIL (device=1 OR device = 2) DO		WriteString["Where to send. Enter 1 for Stinger, 2 for PlateMaker: "];		device _ ReadOctal[]; PutCR[]; ENDLOOP;	WriteString["Filename to read: "];	ReadLine[filename]; PutCR[];	pa _ GetPrinterAttributes[(IF device=1 THEN Stinger ELSE DLP1)];--first see that there is a file on the disk	[h] _ NewWordStream[filename, Read];	--open file for testing.	bufferSeg _ NewDataSegment[DefaultBase, (bufferWordLen+255)/256];	inCoreAddress _ SegmentAddress[bufferSeg];l2999e1k72(635)\i2bI16B16b13B16b12B16i18I2i6bI9B10i30I836i1I69i43I39i24I67i1I	streamPosition _ 3*2;--address by bytes, not words	SetPosition[h, streamPosition];	scratch _ h.get[h];	IF scratch # PressPassword THEN ERROR IllegalPressFile;	bandNum _ firstBand _ h.get[h];	lastBand _ h.get[h];	bitMargin _ h.get[h];	bitWordCt _ h.get[h];	IF ~(lastBand > firstBand) THEN ERROR NoImageInFile;	IF ~(bitWordCt>0) THEN ERROR NoImageInFile;	FOR i: CARDINAL IN [1..3] DO scratch _ h.get[h]; ENDLOOP; --get bitPage	bitPage _ scratch;	totalBands _ lastBand-firstBand+1;	--calculate figures for scan line transfers	roundedBytesPerBand _ ((bitWordCt * bandWidth + 1023)/1024) * 1024 * 2;--i.e., # of bytes in band, rounded up to 1K bound--set up this record before calling the printer (this sequence useful for debugging)	frstScan _ firstBand*bandWidth; lstScan _ (lastBand*bandWidth) + bandWidth-1;	attr _ [scanDirection: pa.scanDirection, filler: 0, firstScan: frstScan, lastScan: lstScan, margin: bitMargin, bitWc: bitWordCt];--OK, we think the file is fine, try to get the printer.	ch _ 'Y;	WHILE  ch='Y DO		IF PrinterReady[(IF device=1 THEN Stinger ELSE DLP1), 2] THEN EXIT;		ch _ 'r;		WHILE ~(ch='Y OR ch='N) DO			WriteString["Stinger not available, retry? (Y/N): "L];			ch _ UpperCase[ReadChar[]]; WriteChar[ch]; WriteChar[CR];		ENDLOOP;	ENDLOOP;	IF ch#'Y THEN GOTO exit;	WriteLine["Sending file"];	SendPageAttributes[@attr];	--send the attributes of this page--transfer the file.	SetRetries[60000];--for debugging on remote end	FOR bandNum IN [0..totalBands)	DO		streamPosition _ bandNum*roundedBytesPerBand+(2048 * bitPage);--i.e., in TfsPages, bandNum*tfsPagesPerBand + 1		SetPosition[h, streamPosition];	--now positioned to first word of band.		FOR scanNum IN [0..bandWidth)		DO			IF h.endof[h] THEN ERROR FileTooShort;			wordsRead _ ReadBlock[h, inCoreAddress, bitWordCt];					SendLine[inCoreAddress];		ENDLOOP;	ENDLOOP;	DeleteDataSegment[bufferSeg];	h.destroy[h];	CloseConnection[];	WriteLine["All ok"L];EXITSexit=>NULL;END;--of SendImage--def these locally for debugging and to avoid the netSendImage[];--debugging.END. -- PressNetSendFile.mesa-- Last Edited:  November 20, 1981  7:17 PM   By:  GWilliams -- Last Edited:  December 10, 1981  6:52 PM   By:  GWilliams--fixed stream addressing bug. \23i29I373i13I1i1I56i43I73i50I4i82I211i57I362i34I1i20I20i30I101i48I1i1I32i41I300i14bI1Bi55I13i12I6i25I1i
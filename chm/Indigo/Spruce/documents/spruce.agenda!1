XEROXPALO ALTO RESEARCH CENTERSystems Science LaboratoryAugust 10, 1978Draft Draft Draft Draft Draft Draft Draft Draft Draft Draft Draft Draftz18556l3033c(2116)\f2 5f0 1b26Bi27I17f7b71f0BTo	Spruce Implementation InterestFrom	Dan SwinehartSubject	Spruce Problems and Shortcomingsz19050e24j\f1 2t1 1f0t0 32f1 4t1 1f0t0 14f1 8f0This document lists, under various general headings, the things I and others have identified as necessary to produce the "ideal" Spruce. Of course, not all these things will happen, but it is useful to define the entire space as an aid to decision making. Within each category, I have marked those entries that I deem crucial by numbering them in bold face; entries with italicized numbers I deem important but not so crucial. The rest would be nice -- numbers in small fonts indicate wishful thinking.z19050e24jThe following (Swinehart) log book entries contain useful design notes:z19050e24j8-4-77	Error reporting, report destination considerations.	RFS lecture on how Spruce imaging worksz19050e24j8-17-77	Checklist of projects, some design details.z19050e12j8-29-77	(p2) A way to do the log file, suggested files involved.z19050e12j10-23-77 Some ideas on buffer-ahead, w/marked files -- interim disk.z19050e12jz19050e12jz19050jProgramming Style (S)z19050l4191d2998e12j(0,4191)\b21BS1.	Nomenclature style should be consistent. Follow one of Simonyi's styles, or something.z19050l4191d2998e12jS2.	Window/SpruceFile names should all be revised to something more reasonable and application-independent.z19050l4191d2998e12j\i2IS3.	Investigate and eliminate all "~~" comments throughout the system. Also, I9.z19050l4191d2998e12j\i2I69u9US4.	There are places where statics and parameters are used wrong, redundantly, confusingly -- especially printDoc, pDoc, throughout both systems, but not exclusively.z19050l4191d2998e12jz19050j(2116)Programming Improvements (cleanliness, robustness) (I)z19050l4191d2998e12j(0,4191)\b54BI1.	Use checkpoint mechanism to store and read back "page data" between interpretation and printing passes.z19050l4191d2998e12j\i4II2.	Investigate switch to compacting storage allocator or to IFS-style VMEM/Overlay scheme -- probably not good idea.z19050l4191d2998e12j\f1 2f0I3.	Investigate reassignment of some or all of installation responsibilities to Sprint. Spruce then more of an application-independent spooler. Would then probably parse stand-alone requests directly, etc. Problem: error reporting and recovery now requires additional work.z19050l4191d2998e12jI4.	SpruceSpool procedures should be reorganized and rethought. Interface to Post functions should be rethought. See also M1, M2.z19050l4191d2998e12j\113u16UI5.	Spruce should not be done using OutLd at all (should be revived via counter-Junta). Sprint should be run as an InLd only after it suspends via OutLd for possible continuance.z19050l4191d2998e12j\i2I2i6I78i7II6.	Find way to suspend Sprint, as now, and run entirely new copy of same in response to high-priority printing need. Could even happen half-through a printing run, w/ appropriate intermediate break page (hard!). Requires finding ways to allocate subfiles within band file. Also, U7.z19050l4191d2998e12j\i2I22i6I244u9UI7	Way to record print-time problems on break page (hard!). Or have extra "canned" break pages to print in addition to the major one. Also, U8.z19050l4191d2998e12j\134u8U1bI8.	Read-Write access currently allowed to same file to implement band merge. Revise to use multiple subfiles, arranged backwards from other end. Also, P6.z19050l4191d2998e12j\i2I144u9UbI9.	Investigate and eliminate all "~~" comments throughout the system. Also, S3.z19050l4191d2998e12j\i2I69u9UI10.	Offset in SPruceFile is P1-based; recover in V to R, R to V.z19050l4191d2998e12j\f1 3f0I11.	Save only file maps for files not accessed via buffers?z19050l4191d2998e12j\f1 3f0I12.	Many portions of system would submit well to object-oriented approach. Particularly SproullerQ and its maintenance. Would be a good way to approach I4, perhaps some of M1, M2.z19050l4191d2998e12j\f1 3f0 118u59UI13.	Sprint should respond to print request with a "busy, come back soon" abort -- precanned, like the status reply.z19050l4191d2998e12j\i4II14.	Is there a way to do the left over table right?z19050l4191d2998e12jI15.	Do Pimlico, Puffin, Penguin, ...,  engine queue control right.z19050l4191d2998e12jz19050j(2116)Performance (P)z19050l4191d2998e12j(0,4191)\b15BP1.	Improvement of some sort in buffering for files. Current system does virtually no buffering.z19050l4191d2998e12j\b3BP1-1. Overlap disk I/O with computing to achive disk buffering. The desire for this ideal prompted removal of old Spruce disk buffering. May require pre-allocation of fixed total # of disk buffers. Could also increase # of buffers filled each time.z19050l4191d2998e6j\i6IP2.	Implement "write without first reading" option for linearly written files.z19050l4191d2998e12jP3.	Use overlay facilities more fully in Sprint -- for system initialization activities, particularly. Alternatively, use overlay initialization routines where needed (much more wasteful of disk space, a little faster).z19050l4191d2998e12j\i3IP4.	After P3, analyze Sprint Interpret storage usage, make more robust and make better use of memory. Consider fixed-size, fixed-use blocks for "cacheable" functions. See also P1-1.z19050l4191d2998e12j\i2I8u2U155u13UP5.	xxxx Better Ether ear.z19050l4191d2998e12j\4b4BP6.	Read-Write access currently allowed to same file to implement band merge. Revise to use multiple subfiles, arranged backwards from other end. Also, I8.z19050l4191d2998e12j\i2I144u9UP7.	Break up Press files into multiple runs to print bigger ones. On some printers, use more revolutions to print complicated pages. See also E7.z19050l4191d2998e12j\f1 2f0 131u11UP8.	Find contiguous M31 areas during installation -- when OS allows it.z19050l4191d2998e12j\f1 2f0P9.	Extend ISF map in larger increments to increase speed. Find out why length hints for Spruce-created files are often not correct. Store each file's map within the file for speedier installation -- use as hint, but should not often be wrong, since files do not change length.z19050l4191d2998e12j\f1 2f0P10.	xxxx Write microcode to rotate 8-row groups to speed up Alto bit map printing.z19050l4191d2998e12j\i4I1b5BP11.	Write microcode for inner character show loop.z19050l4191d2998e12j\f1 4f0P12.	Could checkpoint parts of DocG's early, leave rest for spooler control -- would save muy space in spooler -- needed?z19050l4191d2998e12j\f1 4f0P13.	Improve band merge pass -- use in-core buffer?z19050l4191d2998e12jP14.	Recognize rectangles.z19050l4191d2998e12jP15.	Use "Knox"-style display interface for installation.z19050l4191d2998e12j\f1 5f0z19050j(2116)Bugs (B)z19050l4191d2998e12j(0,4191)\b8BB1.	Inadequate reporting of font names, substituted font names, etc., in various error messages.z19050l4191d2998e12jB2.	Count-H timing bugs -- Sequoia control. General printer control loop. Current manifestations include occasional blank pages after complex pages, etc. -- needs one more serious pass on Dover control loop. R. Sweet has contributed one sample file, and I have another.z19050l4191d2998e12j\b4BB3.	It's possible that "csiz" calculation in ShowInit() is too conservative -- doesn't add initialization code to available space? Bears checking out.z19050l4191d2998e12j\b2BB4.	xxxx Jam laser on during power up sequence, verify polygon speed correct and stable before starting system; include power up sequence in initial spool queue; require manual power up for stand-alone use.z19050l4191d2998e12j\i3I1b5BB5.	Check to see if "Verbose" switch is still being turned off when the break page has accepted too many error messages.z19050l4191d2998e12jB6.	Version number prints in octal on Spruce status display.z19050l4191d2998e12jB7.	Remove 2^14 word entity size restriction.z19050l4191d2998e12jz19050j(2116)Printing Capabilities (C)z19050l4191d2998e12j(0,4191)\b25BC1.	Extend Press format (or use C2 method) to include "printed by" as well as "created by" information. Possibly to include bit map representation for special fonts, probably in device-dependent resolutions. Also extend (C2 not acceptable) to describe complexity of document, for use in optimizing processing.z19050l4191d2998e12j\i2I9i5I16u2U187u2UC2.	Extend EFTP communications protocol to include an extra "Print Request Directory", with its own distinctive password, in the trailing page. Press file, unchanged, would precede this trailer. Would supplant most C1 activities, allow additional print priority requests, etc. Some of these things could also be done with an extended command protocol. See also U2.z19050l4191d2998e12j\i2I9i4I129i6I65u2U135u12UC3.	Capability spooling. Various IFS spooling paradigms.z19050l4191d2998e12j\f1 2f0C4.	Handle intensity requests using the ink well.z19050l4191d2998e12jC5.	Handle color requests correctly (Pimlico only).z19050l4191d2998e12jC6.	Print splines, objects, perhaps arbitrary bit maps at low Alto resolution.z19050l4191d2998e12j\f1 2f0C7.	New Dover status signals.z19050l4191d2998e12jC8.	Get "official" word on uses of fields in serial #, machine id fields -- modify Spruce appropriately, broadcast the word. (Make Sequoia decision? Pimlico?)z19050l4191d2998e12jC9.	"JDS" Spruce -- use XM to get many many fonts at once.z19050l4191d2998e12jz19050j(2116)Communication with Users, User Control Facilities (U)z19050l4191d2998e12j(0,4191)\b53BU1.	After M1, add log file notion, for use by user interface -- longer history. Entire message/performance/error etc., posting should be integrated. Possibly using the "pDoc" structure as a focus. Also, M2.z19050l4191d2998e12j\i2I8u2U185u9UU2.	Extend EFTP protocol, server to user, to include with ACK a document number for subsequent use in status requests -- or use server socket # somehow, maintain correlation. Extend EARS protocol to provide additional global status, respond to document-specific requests, etc.z19050l4191d2998e12j\i2I9i4I167i4IU3.	Spooler user interface should bereplaced entirely -- by K. Knox type menu? Orbittest or D1Test or ... type menu?z19050l4191d2998e12jU4.	Sprint should always listen, at least a bit, to the keyboard, allowing an abort (equiv. to "suspend to receieve file", but turns off printing) so that interaction can take place.z19050l4191d2998e12j\i2IU5.	Spooler user interface facilities in support of:reprint, change page #, change # copies, abort, reprioritize, release delayed document, etc. See also E2.z19050l4191d2998e12j\i2I144u11UU6.	Debugging facility allowing Spruce to latch to first host heard, or to be instructed to listen only to {net x, host y}.z19050l4191d2998e12j\i2IU7.	Find way to suspend Sprint, as now, and run entirely new copy of same in response to high-priority printing need. Could even happen half-through a printing run, w/ appropriate intermediate break page (hard!). Requires finding ways to allocate subfiles within band file. Also, I6.z19050l4191d2998e12j\i2I22i6I244u8UU8.	Way to record print-time problems on break page (hard!). Also, I7.z19050l4191d2998e12j\61u8UU9.	xxxx (but more could be done) Revise print pass cursor use.z19050l4191d2998e12j\f1 2f0 2b4B1f1 24f0b1BU10.	Reprint of files other than most recent, directly from bands. See U7 for enabling implementation.z19050l4191d2998e12j\67u35UU11.	Shouldn't really allow stand-alone invocation of reprint without password or similar protection.z19050l4191d2998e12jU12.	Remote "telnet" style control and detailed status analysis of Server systems (should involve remote Swat as well!!!).z19050l4191d2998e12j\f1 3f0U13.	More cross-system exchange of information? Version #'s, spooling or not, report status in LevReport. Revise version # stuff.z19050l4191d2998e12jU14.	Post sending host on break page, esp. when nothing more is known.z19050l4191d2998e12jU15.	Server status server (in clearinghouse?) reports status of printer while it's down, etc.; helps negotiate printer choice....z19050l4191d2998e12j\f1 3f0U16.	See above for extended EARS protocol ideas. Simpler first step: report more load and estimate information in EARS status report.z19050l4191d2998e12jU17.	Improved break page -- see S. Card. See also Spruce messages from S. Card. re: Empress.z19050l4191d2998e12jz19050j(2116)Error Management (E)z19050l4191d2998e12j(0,4191)\bE1.	Need way to report error parameter information (strings, structures, values, etc.) more fully to spooler. Record in inMsg? in checkpoint file? Not clear. This level needs more work.z19050l4191d2998e12jE2.	User interface-invoked facilities for operator-assisted queue repair and scavenging. Or design a responsible queue-scavenging algorithm and build that. See also U5.z19050l4191d2998e12j\i2I154u11UE3.	Find a reasonable way to deal with Spruce errors, if there are any left.z19050l4191d2998e12j\39i6IE4.	Find a way to deal with the few remaining SysErr calls -- mostly disk errors and storage management problems.z19050l4191d2998e12j\i2I44i6IE5.	More data-type-specific parameter codes in Spruce Error Messages -- approaching style of PutTemplate rather than Swat.z19050l4191d2998e12jE6.	Catch loops that return to same page of same file multiple times. Revise pagesPrinted decision in print program for Orbit timeouts, etc.; things that are not likely to get better, and that are document decpendent.z19050l4191d2998e12j\i2IE7.	Not all Press file format errors need to be document-fatal; some could just skip or truncate the current page, or terminate at the current position in current page, following with commented break page -- better all in all than the special method now used to create error break pages.z19050l4191d2998e12jE8.	Check for writing a read-only page.z19050l4191d2998e12jE9.	Watch-dog timer to restart if Spruce gets lost? In refresh microcode?z19050l4191d2998e12jE10.	Build restart facility? Dependent on completion of E2.z19050l4191d2998e12j\56u2UE11.	Better reporting of file name/number information in error reports?z19050l4191d2998e12jE12.	Record higher stack-top than is true, trap overflow errors, for early warning when stack fails to be big enough.z19050l4191d2998e12jE13.	When Print returns with non-fatal report (was behind, etc.), should (ironically) swap false -- not true -- to report the problem, then come back and get the next file.z19050l4191d2998e12jE14.	Print code should dally until last opportunity to jam is past. Will delay progress a bit.z19050l4191d2998e12jz19050j(2116)Measurement (M)z19050l4191d2998e12j(0,4191)\b15BM1.	Reimplement reporting (high-level, per-document information about what's happening) and metering (low-level, performance-related stuff) code.z19050l4191d2998e12j\i4IM2.	After M1, add log file notion, for use by user interface -- longer history. Entire message/performance/error etc., posting should be integrated. Possibly using the "pDoc" structure as a focus. Also, U1.z19050l4191d2998e12j\i2I8u2U185u9UM3.	Neat way of recording amount of each context's stack actually used, for use in tuning system stack needs.z19050l4191d2998e12j